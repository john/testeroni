!!! 5
%html
  %head
    %meta{:charset => 'utf-8'}
    %meta{'http-equiv' => 'X-UA-Compatible', :content => 'IE=edge,chrome=1'}
    
    %title= @title ||= 'Testeroni'
    
    %meta{:name => 'description', :content => 'A platform for casual and fun learning. Make and take tests your own tests. Answers can be multiple choice or true/false, and tests can be shared and embedded.'}
    %meta{:name => 'viewport', :content => 'width=device-width, initial-scale=1.0'}
    
    =stylesheet_link_tag(:flutie, 'testeroni', 'https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.7/themes/accordion/jquery-ui.css',  :cache => true)
    =javascript_include_tag('http://use.typekit.com/jxe0dey.js')
    %script{:type => "text/javascript"} try{Typekit.load();}catch(e){}
    =javascript_include_tag('http://www.google.com/jsapi?key=ABQIAAAAnohM6sqTs6drjmtNvnIyhBQX4KEUxjBL_ZDpzqYIgEd3Cy73NxTBwcj0akdZnV23u8exfLERTanWEw')
    :javascript
      google.load("jquery", "1.4.4");
      google.load("jqueryui", "1.8.7");
      
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-20111813-1']);
      _gaq.push(['_trackPageview']);
      
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    
    -# combine all these in prod, plus the shit at the bottom of this template too
    =javascript_include_tag("/wmd/wmd.js")
    =javascript_include_tag("/wmd/showdown.js")
    =csrf_meta_tag
    
  %body
    -# TODO: add controller and style support for this
    -if @promo
      #promo{:style => 'display:none;'}
        .notice
          .promo_close
            = link_to_function('x', "Tstrni.promo.hide();")
          = @promo[:message]
      :javascript
        $(document).ready(function(){
          setTimeout(Tstrni.promo.show, 1000);
        })
        
    #head-wrap
      #header
        .right
          .user
            -if user_signed_in?
              hello #{link_to current_user.display_name, person_with_name_path(current_user.id, current_user.slugged_display_name)}
              |
              #{link_to 'logout', destroy_user_session_path}
            -else
              = link_to_function('Join Now.', "signupThenGoTo('')")
              &nbsp; Already a member?
              = link_to('Log in', new_user_session_path)
          .search
            =form_tag(search_path) do
              %input{:type => 'text', :id => 'q', :name => 'q', :value => 'search tests', :onclick => "this.value=''; this.style.color='#000'"}
        #logotype
          -if request.path == '/'
            Testeroni
          -else
            %a{:href => '/'}<
              Testeroni
              
    #container
      =render(:partial => 'shared/flash', :locals => {:flash => flash})
      
      =yield
      
    #foot-wrap
      #footer
        %table{:style => 'width:120px;'}
          %tr
            %td{:style => 'border:0;'}
              =link_to('about', about_path)
            %td{:style => 'border:0;'}
              &#183;
            %td{:style => 'border:0;'}
              =link_to('contact', contact_path)
            %td{:style => 'border:0;'}
            -#  &#183;
            -#%td{:style => 'border:0;'}
            -#  %a.twitter-share-button{:href => "http://twitter.com/share", 'data-count' => "none", 'data-via' => "besteroni"} Tweet
            
        %script{:type => "text/javascript", :src => "http://platform.twitter.com/widgets.js"}
      
    - if @user
      #signup.roundborder{:style => 'display:none'}
        %div.dismiss
          %a.close [x]
        .account
          %p
            Already have an account?
            = link_to('Log in', new_user_session_path)
          %h3 Create an account
          = render(:partial => 'registrations/services', :locals => {:redirect_to => new_test_path})
          
          .clearfix
          %div{:style => 'padding-top:20px;', :class => 'show_twitter'}>
            Don't have a Facebook or Twitter account?
            %a#use_email{:href =>"#"} Use your email
        .account{:style => 'display:none;'}
          %h4 Create an account
          = form_for(@user, :url => registration_path(@user)) do |f|
            -#= devise_error_messages!
            = f.label :email
            = f.text_field :email
            
            = f.label :display_name, "Display name (Best to use your real name)"
            = f.text_field :display_name
            
            = f.label :password
            = f.password_field :password
            
            %div
              %div{:style => 'float:right; padding-top:15px;'}
                = link_to_function('Cancel', "$('.account').toggle()")
              .submit
                = f.submit "Sign up", :class => 'btn'
            
                -#{f.check_box :email_list, {}, 'true', 'false'} Get email updates from Testeroni
        .caption{:style => 'padding-top:25px;'}
          By creating an account on Testeroni you are indicating that you
          %br have read and agree to the
          =link_to('Terms of Service', terms_path)
    =javascript_include_tag('rails')
    =javascript_include_tag 'jquery.lightbox_me.js'
    =javascript_include_tag('jquery.ba-bbq.min.js')
    =javascript_include_tag('tstrni.js')
    
    :javascript
    
      var _gaq = [['_setAccount', 'UA-XXXXX-X'], ['_trackPageview']];
      (function(d, t) {
        var g = d.createElement(t),
        s = d.getElementsByTagName(t)[0];
        g.async = true;
        g.src = ('https:' == location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        s.parentNode.insertBefore(g, s);
      })(document, 'script');

      function signupThenGoTo(url) {
        // redirect only works for people using the traditional signup form.
        // need something that works with auth services too -- session? cookie?
        $('#return_to').val(url);
        
        $('#signup').lightbox_me({
            centered: true,
            overlaySpeed:200,
            lightboxSpeed:200,
            overlayDisappearSpeed:200,
            onLoad: function() { 
              $('#user_username').focus()
            }
          });
        return false;
      }

      $(document).ready(function() {
        $('#use_email').click(function() {
          $('.account').toggle();
          $('#user_username').focus();
        });
      });